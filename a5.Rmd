---
output: html_document
---
```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(hrbrthemes)
library(viridis)
library(tidyr)
library(plotly)
```

# Bank Accounts Historical Transactions Visualizations

## 1.Explore all accounts. Create visualizations that combine or these account characteristics:
  * Whether an account has a credit card or not
  * Whether an account has a loan or not
  * The average balance for the account

```{r, message = FALSE, echo=FALSE}

accounts <- read.csv("data/accounts_analytical.csv")
transactions <- read.csv("data/transactions.csv")

accounts = accounts %>% 
  mutate(has_credit = if_else(is.na(credit_cards),
                               true = 'No credit card', false = 'has credit card'))

mean_balance <- transactions %>%
  group_by(account_id) %>%
  summarise(mean_balance = mean(balance))

accounts = accounts %>% 
  mutate(has_loan = if_else(is.na(loan_default),
                              true = 'No Loan', false = 'Has Loan'))

p1 <- accounts %>%
  inner_join(mean_balance, by = ('account_id')) %>%
  select(account_id, has_credit, mean_balance, has_loan)

ggplot(p1, aes(x=mean_balance, color = has_loan, fill = has_loan )) +
  geom_density(alpha=0.5) +
  facet_grid(has_credit ~ .) +
  theme_ipsum() +
    labs( title = "Account characteristics",
          xlab = "The average balance for the account",
          ylab = "Density")
```


## 2. What is the distribution of all loans and what are their characteristics?

```{r, echo=FALSE, warning=FALSE}
loan_12 = accounts$loan_amount[accounts$loan_term==12]
loan_24 = accounts$loan_amount[accounts$loan_term==24]
loan_36 = accounts$loan_amount[accounts$loan_term==36]
loan_48 = accounts$loan_amount[accounts$loan_term==48]
loan_60 = accounts$loan_amount[accounts$loan_term==60]

fig <- plot_ly(
  x = loan_12,
  type = "histogram",
  alpha = 0.5,
  name = "12",
  title = "Loan Amounts")

fig <- fig %>% add_histogram(x = loan_24, name = "24")
fig <- fig %>% add_histogram(x = loan_36, name = "36")
fig <- fig %>% add_histogram(x = loan_48, name = "48")
fig <- fig %>% add_histogram(x = loan_60, name = "60")
fig <- fig %>% layout(barmode = "overlay", title="Histogram of loan amounts of different terms")
fig <- fig %>% layout(xaxis = list(title="loan amounts"), yaxis = list(title="num of records"))
fig
```


## 3. Is there a relationship between a good or bad loan and the time between an account is opened an the loan is created? Is there a specific set of accounts that seem to be at higher or lower risk of defaulting?


```{r, echo=FALSE, warning=FALSE, message=FALSE}
fig <- plot_ly(
  x = accounts$acct_creation_date,
  y = accounts$loan_default,
  type = "scatter",
  alpha = 0.5,
  name = "12"
)
fig <- fig %>% layout(
    xaxis = list(title="Year"),
  yaxis = list(title="Loan status"),
  title = "Loan default vs. Account Open date"
    )
fig
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
fig <- plot_ly(
  x = accounts$loan_date,
  y = accounts$loan_default,
  type = "scatter",
  alpha = 0.5,
    xaxis = list(title="Year"),
  yaxis = list(title="Loan status"),
  title = "Loan default vs. Loan Open date"
)
fig <- fig %>% layout(
    xaxis = list(title="Year"),
  yaxis = list(title="Loan status"),
  title = "Loan default vs. Loan Open date"
    )
fig
```

## 4. For the account with the highest number of transactions, make a time series line plot for the behavior of the account over time, including all debits and credits, the different methods, and the with the different categories.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
most_freq = tail(names(sort(table(transactions$account_id))),1)
most = transactions[transactions$account_id==most_freq,]
```

# Transaction of account 8261 with different type
```{r, echo=FALSE, warning=FALSE, message=FALSE}
most %>% 
  ggplot(aes(x=as.Date(date),y=amount,color=type)) +
  geom_line() +
  facet_wrap(~type,ncol=1,strip.position = "left") +
  labs(x='Date', title = "transaction of account 8261 with different type")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
most[!most$method=='',] %>% 
  ggplot(aes(x=as.Date(date),y=amount,color=method)) +
  geom_line() +
  facet_wrap(~method,ncol=1,strip.position = "left") + 
  labs(title="Transaction of account 8261 with different method", x="Date")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
most[!most$category=='',] %>%
  ggplot(aes(x=as.Date(date),y=amount,color=category)) +
  geom_line() +
  labs(title="Transaction of account 8261 with different category", x="Date")
```


## 5. Explore the validity of the data for the case whether or not an account has a credit card and whether or not they have associated credit card transactions. Is there anything worth noting?




